<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT umiBahagia - Manajemen Tugas & Pembayaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Library untuk export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-800 mb-2">
                <i class="fas fa-tasks mr-2"></i>PT umiBahagia
            </h1>
            <p class="text-gray-600">Sistem Manajemen Tugas & Pembayaran</p>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-blue-500">
                <h3 class="text-sm font-medium text-gray-500">Total Tugas</h3>
                <p id="totalTasks" class="text-2xl font-semibold">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-green-500">
                <h3 class="text-sm font-medium text-gray-500">Total Terbayar</h3>
                <p id="totalPaid" class="text-2xl font-semibold">Rp 0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-red-500">
                <h3 class="text-sm font-medium text-gray-500">Total Belum Terbayar</h3>
                <p id="totalUnpaid" class="text-2xl font-semibold">Rp 0</p>
            </div>
        </div>

        <!-- Task Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
            <div class="flex justify-between items-center bg-blue-600 text-white p-4">
                <h2 class="text-lg font-semibold">Daftar Tugas & Pembayaran</h2>
                <button onclick="exportToPDF()" class="px-4 py-2 bg-white text-blue-600 rounded-md hover:bg-blue-50 flex items-center">
                    <i class="fas fa-file-pdf mr-2"></i>Export PDF
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full" id="taskTable">
                    <thead class="bg-blue-600 text-white">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold">Tanggal</th>
                            <th class="py-3 px-4 text-left font-semibold">Tugas</th>
                            <th class="py-3 px-4 text-left font-semibold">Status</th>
                            <th class="py-3 px-4 text-left font-semibold">Keterangan</th>
                            <th class="py-3 px-4 text-right font-semibold">Harga (Rp)</th>
                            <th class="py-3 px-4 text-center font-semibold">Pembayaran</th>
                            <th class="py-3 px-4 text-center font-semibold">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="taskTableBody" class="divide-y divide-gray-200">
                        <!-- Tasks will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add/Edit Task Form -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 id="formTitle" class="text-xl font-semibold text-blue-800 mb-4">
                <i class="fas fa-plus-circle mr-2"></i>Tambah Tugas Baru
            </h2>
            <form id="taskForm" class="space-y-4">
                <input type="hidden" id="editIndex" value="-1">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="tanggal" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="tugas" class="block text-sm font-medium text-gray-700 mb-1">Tugas</label>
                        <input type="text" id="tugas" placeholder="Masukkan tugas" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status Tugas</label>
                        <select id="status" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Belum">Belum Dikerjakan</option>
                            <option value="Selesai">Selesai</option>
                        </select>
                    </div>
                    <div>
                        <label for="harga" class="block text-sm font-medium text-gray-700 mb-1">Harga (Rp)</label>
                        <input type="number" id="harga" placeholder="Masukkan harga" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="pembayaran" class="block text-sm font-medium text-gray-700 mb-1">Status Pembayaran</label>
                        <select id="pembayaran" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Belum">Belum Dibayar</option>
                            <option value="Lunas">Lunas</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="ket" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                    <input type="text" id="ket" placeholder="Tambahkan keterangan (opsional)" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="pt-2 flex space-x-3">
                    <button type="submit" id="submitButton"
                        class="px-6 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                        <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                    <button type="button" id="cancelEdit" onclick="cancelEdit()" class="hidden px-6 py-2 bg-gray-300 text-gray-800 font-medium rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </form>
        </div>

        <!-- Instructions -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">
                <i class="fas fa-info-circle mr-2"></i>Petunjuk Penggunaan
            </h3>
            <ul class="list-disc pl-5 space-y-1 text-gray-700">
                <li>Isi form di atas untuk menambahkan tugas baru</li>
                <li>Klik ikon pensil untuk mengedit tugas yang ada</li>
                <li>Centang kotak untuk menandai tugas sebagai selesai</li>
                <li>Klik ikon tong sampah untuk menghapus tugas</li>
                <li>Klik "Export PDF" untuk menyimpan daftar tugas</li>
                <li>Status tugas: kuning (belum), hijau (selesai)</li>
                <li>Pembayaran: merah (belum), hijau (lunas)</li>
                <li>Data tersimpan otomatis di browser Anda</li>
            </ul>
        </div>
    </div>

    <script>
        // Inisialisasi jsPDF
        const { jsPDF } = window.jspdf;

        // Format number to Rupiah
        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', { 
                style: 'currency', 
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(angka);
        }

        // Format date from YYYY-MM-DD to DD-MM-YYYY
        function formatDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${day}-${month}-${year}`;
        }

        // Format date from DD-MM-YYYY to YYYY-MM-DD (for date input)
        function formatDateForInput(dateString) {
            const [day, month, year] = dateString.split('-');
            return `${year}-${month}-${day}`;
        }

        // Get status badge class based on status
        function getStatusBadge(status) {
            if (status === 'Selesai') {
                return 'bg-green-100 text-green-800';
            }
            return 'bg-yellow-100 text-yellow-800';
        }

        // Get payment badge class based on status
        function getPaymentBadge(status) {
            if (status === 'Lunas') {
                return 'bg-green-100 text-green-800';
            }
            return 'bg-red-100 text-red-800';
        }

        // Database functions
        const db = {
            // Get all tasks
            getTasks: () => {
                const tasks = localStorage.getItem('tasks');
                return tasks ? JSON.parse(tasks) : [];
            },
            
            // Save all tasks
            saveTasks: (tasks) => {
                localStorage.setItem('tasks', JSON.stringify(tasks));
            },
            
            // Add new task
            addTask: (task) => {
                const tasks = db.getTasks();
                tasks.push(task);
                db.saveTasks(tasks);
                return tasks.length - 1; // Return index of new task
            },
            
            // Update task
            updateTask: (index, updatedTask) => {
                const tasks = db.getTasks();
                tasks[index] = updatedTask;
                db.saveTasks(tasks);
            },
            
            // Delete task
            deleteTask: (index) => {
                const tasks = db.getTasks();
                tasks.splice(index, 1);
                db.saveTasks(tasks);
            }
        };

        // Calculate and update summary
        function updateSummary() {
            const tasks = db.getTasks();
            const totalTasks = tasks.length;
            
            let totalPaid = 0;
            let totalUnpaid = 0;
            
            tasks.forEach(task => {
                if (task.pembayaran === 'Lunas') {
                    totalPaid += parseInt(task.harga) || 0;
                } else {
                    totalUnpaid += parseInt(task.harga) || 0;
                }
            });
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('totalPaid').textContent = formatRupiah(totalPaid);
            document.getElementById('totalUnpaid').textContent = formatRupiah(totalUnpaid);
        }

        // Export data ke PDF
        function exportToPDF() {
            const tasks = db.getTasks();
            
            if (tasks.length === 0) {
                showAlert('Tidak ada data untuk diexport', 'error');
                return;
            }

            const doc = new jsPDF();
            
            // Judul dokumen
            doc.setFontSize(18);
            doc.text('Daftar Tugas & Pembayaran PT umiBahagia', 105, 15, { align: 'center' });
            
            // Tanggal export
            doc.setFontSize(10);
            const exportDate = new Date().toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            doc.text(`Dicetak pada: ${exportDate}`, 105, 22, { align: 'center' });
            
            // Summary
            doc.setFontSize(11);
            doc.text(`Total Tugas: ${tasks.length}`, 14, 30);
            
            // Calculate totals
            let totalPaid = 0;
            let totalUnpaid = 0;
            tasks.forEach(task => {
                if (task.pembayaran === 'Lunas') {
                    totalPaid += parseInt(task.harga) || 0;
                } else {
                    totalUnpaid += parseInt(task.harga) || 0;
                }
            });
            
            doc.text(`Total Terbayar: ${formatRupiah(totalPaid).replace('Rp', 'Rp ')}`, 14, 36);
            doc.text(`Total Belum Terbayar: ${formatRupiah(totalUnpaid).replace('Rp', 'Rp ')}`, 14, 42);
            
            // Prepare data untuk tabel
            const tableData = tasks.map(task => [
                formatDate(task.tanggal),
                task.tugas,
                task.status,
                task.ket,
                formatRupiah(parseInt(task.harga)).replace('Rp', 'Rp '),
                task.pembayaran
            ]);
            
            // Buat tabel
            doc.autoTable({
                head: [['Tanggal', 'Tugas', 'Status', 'Keterangan', 'Harga', 'Pembayaran']],
                body: tableData,
                startY: 50,
                styles: {
                    fontSize: 9,
                    cellPadding: 3,
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [70, 130, 180], // Warna biru
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240]
                },
                columnStyles: {
                    0: { cellWidth: 20 }, // Tanggal
                    1: { cellWidth: 'auto' }, // Tugas
                    2: { cellWidth: 20 }, // Status
                    3: { cellWidth: 'auto' }, // Keterangan
                    4: { cellWidth: 25 }, // Harga
                    5: { cellWidth: 20 } // Pembayaran
                },
                didParseCell: function(data) {
                    // Warn cells based on status
                    if (data.column.index === 2) { // Status column
                        if (data.cell.raw === 'Selesai') {
                            data.cell.styles.fillColor = [220, 255, 220];
                        } else {
                            data.cell.styles.fillColor = [255, 255, 200];
                        }
                    }
                    if (data.column.index === 5) { // Payment column
                        if (data.cell.raw === 'Lunas') {
                            data.cell.styles.fillColor = [220, 255, 220];
                        } else {
                            data.cell.styles.fillColor = [255, 220, 220];
                        }
                    }
                }
            });
            
            // Simpan PDF
            doc.save(`Daftar_Tugas_Pembayaran_PT_umiBahagia_${new Date().toISOString().slice(0,10)}.pdf`);
            
            showAlert('PDF berhasil di-generate!', 'success');
        }

        // Load tasks from database
        function loadTasks() {
            const tasks = db.getTasks();
            const tbody = document.getElementById('taskTableBody');
            tbody.innerHTML = '';
            
            tasks.forEach((task, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-3 px-4">${formatDate(task.tanggal)}</td>
                    <td class="py-3 px-4 font-medium">${task.tugas}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs ${getStatusBadge(task.status)}">${task.status}</span>
                    </td>
                    <td class="py-3 px-4 text-gray-500">${task.ket}</td>
                    <td class="py-3 px-4 text-right font-mono">${formatRupiah(parseInt(task.harga))}</td>
                    <td class="py-3 px-4 text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${getPaymentBadge(task.pembayaran)}">${task.pembayaran}</span>
                    </td>
                    <td class="py-3 px-4 text-center space-x-2">
                        <button onclick="editTask(${index})" class="text-blue-500 hover:text-blue-700">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTask(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            updateSummary();
        }

        // Edit task
        function editTask(index) {
            const tasks = db.getTasks();
            const task = tasks[index];
            
            // Set form to edit mode
            document.getElementById('editIndex').value = index;
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Tugas';
            document.getElementById('submitButton').innerHTML = '<i class="fas fa-save mr-2"></i>Update';
            
            // Fill form with task data
            document.getElementById('tanggal').value = formatDateForInput(task.tanggal);
            document.getElementById('tugas').value = task.tugas;
            document.getElementById('status').value = task.status;
            document.getElementById('harga').value = task.harga;
            document.getElementById('pembayaran').value = task.pembayaran;
            document.getElementById('ket').value = task.ket;
            
            // Show cancel button
            document.getElementById('cancelEdit').classList.remove('hidden');
            
            // Scroll to form
            document.getElementById('taskForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Cancel edit
        function cancelEdit() {
            // Reset form
            document.getElementById('taskForm').reset();
            document.getElementById('editIndex').value = "-1";
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-plus-circle mr-2"></i>Tambah Tugas Baru';
            document.getElementById('submitButton').innerHTML = '<i class="fas fa-save mr-2"></i>Simpan';
            document.getElementById('cancelEdit').classList.add('hidden');
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal').value = today;
        }

        // Handle form submission (add/edit)
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const index = document.getElementById('editIndex').value;
            const tanggal = document.getElementById('tanggal').value;
            const tugas = document.getElementById('tugas').value;
            const status = document.getElementById('status').value;
            const harga = document.getElementById('harga').value;
            const pembayaran = document.getElementById('pembayaran').value;
            const ket = document.getElementById('ket').value || '-';
            
            const taskData = {
                tanggal,
                tugas,
                status,
                harga,
                pembayaran,
                ket
            };
            
            if (index === "-1") {
                // Add new task
                db.addTask(taskData);
                showAlert('Tugas berhasil ditambahkan!', 'success');
            } else {
                // Update existing task
                db.updateTask(index, taskData);
                showAlert('Tugas berhasil diperbarui!', 'success');
            }
            
            loadTasks();
            cancelEdit(); // Reset form
        });

        // Show alert message
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-md shadow-md text-white ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Remove alert after 3 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Toggle task status
        function toggleTaskStatus(checkbox, index) {
            const tasks = db.getTasks();
            const task = tasks[index];
            
            task.status = checkbox.checked ? 'Selesai' : 'Belum';
            db.updateTask(index, task);
            loadTasks();
        }

        // Delete task
        function deleteTask(index) {
            if (confirm('Apakah Anda yakin ingin menghapus tugas ini?')) {
                db.deleteTask(index);
                loadTasks();
                showAlert('Tugas berhasil dihapus!', 'success');
            }
        }

        // Set today's date as default
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal').value = today;
            
            // Load tasks when page loads
            loadTasks();
        });
    </script>
</body>
</html>